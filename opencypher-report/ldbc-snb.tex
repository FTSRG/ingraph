\chapter{LDBC Social Network Benchmark}
\label{chp:ldbc-snb}

\section{query-8}

\subsection*{Query specification}

\begin{lstlisting}
// Q8. Most recent replies. This query retrieves the 20 most recent reply comments to all the posts and comments of Person, ordered descending by creation date.
MATCH (start:Person)<-[:HAS_CREATOR]-()<-[:REPLY_OF]-(comment:Comment)-[:HAS_CREATOR]->(person:Person)
RETURN
  person.id AS personId,
  person.firstName AS personFirstName,
  person.lastName AS personLastName,
  comment.id AS commentId,
  comment.creationDate AS commentCreationDate,
  comment.content AS commentContent
ORDER BY
  commentCreationDate DESC,
  commentId ASC
LIMIT 10
\end{lstlisting}

\subsection*{Relational algebra expression}

\begin{flalign*}
\topp{10}{} \Big(\sort{\desc \atom{commentCreationDate}, \asc \atom{commentId}} \Big(\projection{\var{person.id},~\var{person.firstName},~\var{person.lastName},~\var{comment.id},~\var{comment.creationDate},~\var{comment.content}} \Big(\alldifferent{} \Big(\expandout{comment}{person}{Person}{\_e4}{HAS\_CREATOR}{1}{1} \Big(\expandin{\_e1}{comment}{Comment}{\_e3}{REPLY\_OF}{1}{1} \Big(\expandin{start}{\_e1}{}{\_e2}{HAS\_CREATOR}{1}{1} \Big(\getvertices{start}{Person}\Big)\Big)\Big)\Big)\Big)\Big)\Big)
\end{flalign*}

\subsection*{Relational algebra tree}
\adjustbox{max width=\textwidth}{%
\begin{forest} for tree={align=center}
[
	{$\topp{10}{}$
			\\
			\footnotesize
			$\color{gray} \langle \var{id, firstName, lastName, id, creationDate, content} \rangle$
			}
[
	{$\sort{\desc \atom{commentCreationDate}, \asc \atom{commentId}}$
			\\
			\footnotesize
			$\color{gray} \langle \var{id, firstName, lastName, id, creationDate, content} \rangle$
			}
[
	{$\projection{\var{person.id},~\var{person.firstName},~\var{person.lastName},~\var{comment.id},~\var{comment.creationDate},~\var{comment.content}}$
			\\
			\footnotesize
			$\color{gray} \langle \var{id, firstName, lastName, id, creationDate, content} \rangle$
			}
[
	{$\alldifferent{}$
			\\
			\footnotesize
			$\color{gray} \langle \var{start, \_e2, \_e1, \_e3, comment, \_e4, person} \rangle$
			}
[
	{$\expandout{comment}{person}{Person}{\_e4}{HAS\_CREATOR}{1}{1}$
			\\
			\footnotesize
			$\color{gray} \langle \var{start, \_e2, \_e1, \_e3, comment, \_e4, person} \rangle$
			}
[
	{$\expandin{\_e1}{comment}{Comment}{\_e3}{REPLY\_OF}{1}{1}$
			\\
			\footnotesize
			$\color{gray} \langle \var{start, \_e2, \_e1, \_e3, comment} \rangle$
			}
[
	{$\expandin{start}{\_e1}{}{\_e2}{HAS\_CREATOR}{1}{1}$
			\\
			\footnotesize
			$\color{gray} \langle \var{start, \_e2, \_e1} \rangle$
			}
[
	{$\getvertices{start}{Person}$
			\\
			\footnotesize
			$\color{gray} \langle \var{start} \rangle$
			},tier=input,for tree={blue,densely dashed}
]
]
]
]
]
]
]
]
;
\end{forest}
}

\subsection*{Relational algebra tree for incremental queries}
\adjustbox{max width=\textwidth}{%
\begin{forest} for tree={align=center}
[
	{$\topp{10}{}$
			\\
			\footnotesize
			$\color{gray} \langle \var{id, firstName, lastName, id, creationDate, content} \rangle$
			}
[
	{$\sort{\desc \atom{commentCreationDate}, \asc \atom{commentId}}$
			\\
			\footnotesize
			$\color{gray} \langle \var{id, firstName, lastName, id, creationDate, content} \rangle$
			}
[
	{$\projection{\var{person.id},~\var{person.firstName},~\var{person.lastName},~\var{comment.id},~\var{comment.creationDate},~\var{comment.content}}$
			\\
			\footnotesize
			$\color{gray} \langle \var{id, firstName, lastName, id, creationDate, content} \rangle$
			}
[
	{$\alldifferent{}$
			\\
			\footnotesize
			$\color{gray} \langle \var{start, \_e2, \_e1, \_e3, comment, \_e4, person} \rangle$
			}
[
	{$\expandout{comment}{person}{Person}{\_e4}{HAS\_CREATOR}{1}{1}$
			\\
			\footnotesize
			$\color{gray} \langle \var{start, \_e2, \_e1, \_e3, comment, \_e4, person} \rangle$
			}
[
	{$\expandin{\_e1}{comment}{Comment}{\_e3}{REPLY\_OF}{1}{1}$
			\\
			\footnotesize
			$\color{gray} \langle \var{start, \_e2, \_e1, \_e3, comment} \rangle$
			}
[
	{$\expandin{start}{\_e1}{}{\_e2}{HAS\_CREATOR}{1}{1}$
			\\
			\footnotesize
			$\color{gray} \langle \var{start, \_e2, \_e1} \rangle$
			}
[
	{$\getvertices{start}{Person}$
			\\
			\footnotesize
			$\color{gray} \langle \var{start} \rangle$
			},tier=input,for tree={blue,densely dashed}
]
]
]
]
]
]
]
]
;
\end{forest}
}

