\chapter{Schema Inferencing}

Graph query engines often use single-machine (even single-threaded), search-based algorithms. Using these algorithms includes many tradeoffs:

\begin{itemize}
	\item They do not scale well for large graphs.
	\item They cannot run in parallel.
	\item They cannot provide incremental maintenance -- if the graph changes, they have to completely reevaluate the query.
\end{itemize}

However, they have advantageous properties as well:

\begin{itemize}
	\item They are more straightforward to implement than incremental algorithms.
	\item They are typically able to execute with limited memory.
	\item They can access properties of elements (e.g. the \texttt{name} property of a vertex or the \texttt{weight} property of an edge) by using a pointer.
\end{itemize}

\section{Concepts}

Let's take a simple Cypher query, that returns the name :

\begin{lstlisting}[label=lst:schema-inferencing-example, caption=Example query]
MATCH (n:Person)
WHERE n.age > 27
RETURN n.name
\end{lstlisting}

\newcommand{\screenshotscale}{0.45}

\begin{figure}
	\centering
	\input{example-query-plan}
	\caption{Search plan for \autoref{lst:schema-inferencing-example}.}
	\label{fig:neo4-query-plan}
\end{figure}

\begin{figure}
	\centering
	\input{example-schema-inferencing}
	\caption{Relational algebra tree with tuples that stand for the \textcolor{externalschemacolor}{external schema}, \textcolor{extravariablescolor}{extra variables} and \textcolor{internalschemacolor}{internal schema}.}
	\label{fig:example-schema-inferencing}
\end{figure}

There are three key concepts for defining the schema for each operator in the relational algebra plan:

\begin{itemize}
	\item The \emph{external schema} (typeset in \textcolor{externalschemacolor}{\externalschemacolorname}) is a relational schema that defines the schema visible for users (\autoref{fig:example-schema-inferencing}). This schema is similar to the one generated by Neo4j's query planner.

	\item The \emph{extra attributes} (typeset in \textcolor{extravariablescolor}{\extravariablescolorname}) define attributes that are required by an operator's ancestors. For example, the \projectiontext ($\projectionop$) and \selectiontext ($\selectionop$) operators might require additional properties. For \autoref{lst:schema-inferencing-example}, the projection requires the $\var{name}$ attribute, while the selection requires the $\var{age}$.

	\item The \emph{internal schema} (typeset in \textcolor{internalschemacolor}{\internalschemacolorname}) defines a relational schema that contains the external schema plus the extra attributes that are required to locally perform computations.
\end{itemize}

\autoref{fig:neo4-query-plan} illustrates these concepts.

We call the process of inferencing the external schema, the additional attributes and the internal schema as \emph{schema inferencing}.

\section{More examples}

See the Appendices for more examples, starting with the TCK test cases (\autoref{chp:tck}).
